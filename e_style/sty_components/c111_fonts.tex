% ===================================================================
% c111_fonts.tex -- Final Corrected Logic
% ===================================================================

% 1. CLASS OPTION SWITCHES (may be pre-defined by class)
% -------------------------------------------------------------------
% Only define if not already defined by the document class
% Using LaTeX's \@ifundefined to safely check for conditional
\makeatletter
% CJK switch
\@ifundefined{ifcjk}{
    \newif\ifcjk
    \cjkfalse % Default to CJK support DISABLED
}{}
% 12pt switch (for section heading size adjustments)
\@ifundefined{if@e@twelvept}{
    \newif\if@e@twelvept
    \@e@twelveptfalse % Default to standard sizes
}{}
\makeatother
% Note: Options are processed by the document class, not here

% 2. LOAD FONT PACKAGES
% -------------------------------------------------------------------
\RequirePackage{fontspec}
\RequirePackage{noto}
\RequirePackage{sourcecodepro}
\RequirePackage{microtype}
\RequirePackage{silence}
\RequirePackage[warnings-off={mathtools-colon,mathtools-overbracket}]{unicode-math}
% Note: Math fonts (STIX Two, New Computer Modern, XITS, IBM Plex) are
% loaded directly via \setmathfont in section 5. Font files are provided
% by TeX Live packages: stix2, newcomputermodern, xits, plex-otf.
% 3. CONDITIONAL LOADING OF LANGUAGE & DEPENDENT PACKAGES
% -------------------------------------------------------------------
\ifcjk
% --- CJK MODE ---
\WarningFilter{luatexja}{LuaTeX-ja's patch against the microtype package}

% 1. Load luatexja for Japanese support.
\RequirePackage[pass]{luatexja}
\RequirePackage{luatexja-fontspec, luatexja-ruby}

% 2. Load csquotes immediately after. It will now correctly detect the language.
\RequirePackage{csquotes}

% 3. Set Japanese fonts with HanaMin fallback for rare characters.
% HanaMinA: BMP including CJK Ext-A | HanaMinB: SIP including CJK Ext-B through I
\setmainjfont[
    BoldFont={Source Han Serif Bold},
    AltFont={
        {Range="3400-"4DBF, Font=HanaMinA},    % CJK Unified Ideographs Extension A
        {Range="20000-"3FFFF, Font=HanaMinB}, % SIP: CJK Extensions B-I (rare/historical)
    }
]{Source Han Serif}
\setsansjfont[
    BoldFont={Source Han Sans Bold},
    AltFont={
        {Range="3400-"4DBF, Font=HanaMinA},
        {Range="20000-"3FFFF, Font=HanaMinB},
    }
]{Source Han Sans}
\setmonojfont{HanaMinA}
\else
% --- NON-CJK MODE ---
% 1. Load polyglossia for multi-language support.
\RequirePackage{polyglossia}
\setdefaultlanguage{english}
\setotherlanguages{german,french,russian}

% 2. Load csquotes immediately after. It will now correctly detect the language.
\RequirePackage[autostyle]{csquotes}
\fi

% 4. SET MAIN LATIN FONTS (applies to both modes)
% -------------------------------------------------------------------
\setmainfont{Noto Serif}[
    UprightFont=*-Regular,
    BoldFont=*-Bold,
    ItalicFont=*-Italic,
    BoldItalicFont=*-BoldItalic
]
\setsansfont{Noto Sans}[
    UprightFont=*-Regular,
    BoldFont=*-Bold,
    ItalicFont=*-Italic,
    BoldItalicFont=*-BoldItalic
]
\setmonofont{Source Code Pro}

% 5. MATH FONT SETUP
% -------------------------------------------------------------------
% Set math fonts at end of preamble (after all font packages fully initialized)
\AtEndPreamble{%
    \setmathfont[StylisticSet=01]{STIX Two Math}%
    \setmathfont[range={bb}]{New Computer Modern Math}%
    \setmathfont[range={scr,bfscr}, Scale=MatchUppercase]{XITS Math}%
    \setmathfont[range={cal,bfcal}]{IBM Plex Math}%
    \setmathfont[range={frak,bffrak}]{New Computer Modern Math}%
}

% 6. CONDITIONAL EMPHASIS AND TEXT STYLING
% -------------------------------------------------------------------
\ifcjk
    % CJK emphasis: boten (dots) via luatexja-ruby (already loaded above)
    \ltjsetparameter{kanjiskip={0.1\zw plus 0.04\zw minus 0.04\zw}}

    % Redefine \emph for CJK to use boten
    \let\latinemph\emph
    \renewcommand{\emph}[1]{
        \kenten{#1}%
    }

    % For explicit Latin emphasis within CJK text
    \newcommand{\emphLatin}[1]{\latinemph{#1}}
\fi

% 7. 12PT SECTION HEADING SIZE ADJUSTMENTS
% -------------------------------------------------------------------
% When 12pt option is used, adjust section heading sizes accordingly.
% Uses begindocument/end hook to ensure titlesec is fully initialized.
\makeatletter
\AddToHook{begindocument/end}{%
    \if@e@twelvept
        \titleformat{\section}
            {\fontsize{14.4pt}{17.28pt}\selectfont\bfseries}{\thesection}{1em}{}
        \titleformat{\subsection}
            {\fontsize{12pt}{14.4pt}\selectfont\bfseries}{\thesubsection}{1em}{}
        \titleformat{\subsubsection}
            {\fontsize{11pt}{13.2pt}\selectfont\bfseries}{\thesubsubsection}{1em}{}
    \fi
}
\makeatother

% --- End of File ---
\endinput
